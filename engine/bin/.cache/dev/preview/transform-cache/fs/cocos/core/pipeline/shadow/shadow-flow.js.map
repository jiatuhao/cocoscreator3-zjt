{"version":3,"sources":["../../../../../../../../../../cocos/core/pipeline/shadow/shadow-flow.ts"],"names":["ccclass","PIPELINE_FLOW_SHADOW","RenderFlow","ForwardFlowPriority","ShadowStage","LoadOp","StoreOp","TextureLayout","Format","TextureType","TextureUsageBit","ColorAttachment","DepthStencilAttachment","RenderPassInfo","TextureInfo","FramebufferInfo","RenderFlowTag","ShadowType","lightCollecting","shadowCollecting","ShadowFlow","_shadowRenderPass","initialize","info","_stages","length","shadowMapStage","initInfo","push","render","camera","pipeline","_pipeline","shadowInfo","shadows","enabled","type","ShadowMap","validLights","maxReceived","shadowObjects","clearShadowMap","l","light","shadowFrameBufferMap","has","_initShadowFrameBuffer","shadowFrameBuffer","get","shadowMapDirty","resizeShadowMap","size","i","shadowStage","setUsage","updateShadowUBO","destroy","shadowFrameBuffers","Array","from","values","frameBuffer","renderTargets","colorTextures","j","renderTarget","depth","depthStencilTexture","clear","device","shadowMapSize","colorAttachment","format","RGBA8","loadOp","CLEAR","storeOp","STORE","sampleCount","beginLayout","UNDEFINED","endLayout","PRESENT_SRC","depthStencilAttachment","depthStencilFormat","depthLoadOp","depthStoreOp","DISCARD","stencilLoadOp","stencilStoreOp","DEPTH_STENCIL_ATTACHMENT_OPTIMAL","renderPassInfo","createRenderPass","shadowRenderTargets","createTexture","TEX2D","COLOR_ATTACHMENT","SAMPLED","x","y","DEPTH_STENCIL_ATTACHMENT","createFramebuffer","set","clearFramebuffer","width","height","resize","shadowRenderPass","renderPass","name","priority","SHADOW","tag","SCENE","stages"],"mappings":"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"}