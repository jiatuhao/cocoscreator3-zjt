{"version":3,"sources":["../../../../../../../../../cocos/core/pipeline/render-shadow-map-batched-queue.ts"],"names":["getShadowPassIndex","subModels","shadowPassIndices","length","hasShadowPass","j","passes","shadowPassIndex","k","phase","_phaseID","push","SetIndex","UBOShadow","getPhaseID","PipelineStateManager","ShaderPool","SubModelPool","SubModelView","BatchingSchemes","RenderInstancedQueue","InstancedBuffer","RenderBatchedQueue","BatchedBuffer","Color","Mat4","Vec4","Vec3","Shadows","ShadowType","LightType","intersect","getShadowWorldMatrix","_matShadowView","_matShadowViewProj","_vec4ShadowInfo","_vec3Center","_shadowCameraView","_shadowPassIndices","RenderShadowMapBatchedQueue","pipeline","_pipeline","_subModelsArray","_passArray","_shaderArray","_shadowMapBuffer","_device","_shadowInfo","_descriptorSet","_shadowObjects","_shadowUBO","_instancedQueue","_batchedQueue","device","shadows","descriptorSet","shadowObjects","shadowUBO","getBuffer","BINDING","gatherLightPasses","light","cmdBuff","clear","enabled","type","ShadowMap","_updateUBOs","i","ro","model","DIRECTIONAL","add","SPOT","worldBounds","aabbWithAABB","aabb","aabbFrustum","frustum","subModel","shadowPassIdx","pass","batchingScheme","bindBuffer","update","INSTANCING","buffer","get","merge","instancedAttributes","queue","VB_MERGING","shader","handle","SHADER_0","uploadBuffers","recordCommandBuffer","renderPass","ia","inputAssembler","pso","getOrCreatePipelineState","bindPipelineState","bindDescriptorSet","MATERIAL","LOCAL","bindInputAssembler","draw","_x","_y","_far","autoAdapt","node","getWorldRotation","direction","radius","sphere","aspect","halfFar","distance","center","Math","min","COEFFICIENT_OF_EXPANSION","MAX_FAR","getWorldMatrix","orthoSize","far","invert","ortho","near","clipSpaceMinZ","screenSpaceSignY","UVSpaceSignY","perspective","spotAngle","range","multiply","toArray","MAT_LIGHT_VIEW_PROJ_OFFSET","shadowColor","SHADOW_COLOR_OFFSET","set","size","x","y","pcf","bias","SHADOW_INFO_OFFSET"],"mappings":"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"}