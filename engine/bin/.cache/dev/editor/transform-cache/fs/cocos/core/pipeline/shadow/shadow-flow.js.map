{"version":3,"sources":["file:///Applications/CocosCreator/Creator/3.0.0/CocosCreator.app/Contents/Resources/resources/3d/engine/cocos/core/pipeline/shadow/shadow-flow.ts"],"names":["ShadowFlow","RenderFlow","_shadowRenderPass","initialize","info","_stages","length","shadowMapStage","ShadowStage","initInfo","push","render","camera","pipeline","_pipeline","shadowInfo","shadows","enabled","type","ShadowType","ShadowMap","validLights","maxReceived","shadowObjects","clearShadowMap","l","light","shadowFrameBufferMap","has","_initShadowFrameBuffer","shadowFrameBuffer","get","shadowMapDirty","resizeShadowMap","size","i","shadowStage","setUsage","updateShadowUBO","destroy","shadowFrameBuffers","Array","from","values","frameBuffer","renderTargets","colorTextures","j","renderTarget","depth","depthStencilTexture","clear","device","shadowMapSize","colorAttachment","ColorAttachment","format","Format","RGBA8","loadOp","LoadOp","CLEAR","storeOp","StoreOp","STORE","sampleCount","beginLayout","TextureLayout","UNDEFINED","endLayout","PRESENT_SRC","depthStencilAttachment","DepthStencilAttachment","depthStencilFormat","depthLoadOp","depthStoreOp","DISCARD","stencilLoadOp","stencilStoreOp","DEPTH_STENCIL_ATTACHMENT_OPTIMAL","renderPassInfo","RenderPassInfo","createRenderPass","shadowRenderTargets","createTexture","TextureInfo","TextureType","TEX2D","TextureUsageBit","COLOR_ATTACHMENT","SAMPLED","x","y","DEPTH_STENCIL_ATTACHMENT","createFramebuffer","FramebufferInfo","set","clearFramebuffer","width","height","resize","shadowRenderPass","renderPass","name","PIPELINE_FLOW_SHADOW","priority","ForwardFlowPriority","SHADOW","tag","RenderFlowTag","SCENE","stages"],"mappings":"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"}