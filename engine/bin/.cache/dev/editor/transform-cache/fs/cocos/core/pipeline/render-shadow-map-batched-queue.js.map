{"version":3,"sources":["file:///Applications/CocosCreator/Creator/3.0.0/CocosCreator.app/Contents/Resources/resources/3d/engine/cocos/core/pipeline/render-shadow-map-batched-queue.ts"],"names":["_matShadowView","Mat4","_matShadowViewProj","_vec4ShadowInfo","Vec4","_vec3Center","Vec3","_shadowCameraView","_phaseID","_shadowPassIndices","getShadowPassIndex","subModels","shadowPassIndices","length","hasShadowPass","j","passes","shadowPassIndex","k","phase","push","RenderShadowMapBatchedQueue","constructor","pipeline","_pipeline","_subModelsArray","_passArray","_shaderArray","_shadowMapBuffer","_device","_shadowInfo","_descriptorSet","_shadowObjects","_shadowUBO","_instancedQueue","_batchedQueue","device","shadows","descriptorSet","shadowObjects","shadowUBO","getBuffer","UBOShadow","BINDING","RenderInstancedQueue","RenderBatchedQueue","gatherLightPasses","light","cmdBuff","clear","enabled","type","ShadowType","ShadowMap","_updateUBOs","i","ro","model","LightType","DIRECTIONAL","add","SPOT","worldBounds","intersect","aabbWithAABB","aabb","aabbFrustum","frustum","subModel","shadowPassIdx","pass","batchingScheme","bindBuffer","update","BatchingSchemes","INSTANCING","buffer","InstancedBuffer","get","merge","instancedAttributes","queue","VB_MERGING","BatchedBuffer","shader","ShaderPool","SubModelPool","handle","SubModelView","SHADER_0","uploadBuffers","recordCommandBuffer","renderPass","ia","inputAssembler","pso","PipelineStateManager","getOrCreatePipelineState","bindPipelineState","bindDescriptorSet","SetIndex","MATERIAL","LOCAL","bindInputAssembler","draw","_x","_y","_far","autoAdapt","node","getWorldRotation","direction","radius","sphere","aspect","halfFar","distance","center","Math","min","Shadows","COEFFICIENT_OF_EXPANSION","MAX_FAR","getWorldMatrix","orthoSize","far","invert","ortho","near","clipSpaceMinZ","screenSpaceSignY","UVSpaceSignY","perspective","spotAngle","range","multiply","toArray","MAT_LIGHT_VIEW_PROJ_OFFSET","Color","shadowColor","SHADOW_COLOR_OFFSET","set","size","x","y","pcf","bias","SHADOW_INFO_OFFSET"],"mappings":"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"}